@page "/"
@inject StatsApiService StatsService
@inject LibraryApiService LibraryService
@inject TranslationApiService TranslationService
@inject NotificationService NotificationService
@implements IDisposable

<PageTitle>Dashboard - Translarr</PageTitle>

<RadzenText TextStyle="TextStyle.H3" class="rz-mb-4">Dashboard</RadzenText>

@if (_isLoading)
{
    <div class="rz-text-align-center rz-my-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
    </div>
}

@if (_stats != null)
{
    <!-- Statistics Cards -->
    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.DisplayH5">@_stats.TotalFiles</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Total Files</RadzenText>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard Style="border-left: 4px solid var(--rz-success);">
                <RadzenText TextStyle="TextStyle.DisplayH5" Style="color: var(--rz-success);">@_stats.ProcessedFiles</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Processed</RadzenText>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard Style="border-left: 4px solid var(--rz-warning);">
                <RadzenText TextStyle="TextStyle.DisplayH5" Style="color: var(--rz-warning);">@_stats.WantedFiles</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Waiting to Process</RadzenText>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
            <RadzenCard Style="border-left: 4px solid var(--rz-danger);">
                <RadzenText TextStyle="TextStyle.DisplayH5" Style="color: var(--rz-danger);">@_stats.ErrorFiles</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Errors</RadzenText>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Actions Card -->
    <RadzenRow Gap="1rem" class="rz-mb-4">
        <RadzenColumn Size="12">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Actions</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                    <RadzenButton Text="Scan Library"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Click="@ScanLibrary"
                                  Disabled="@_isScanning" />

                    <RadzenButton Icon="translate"
                                  Text="Start Translation"
                                  ButtonStyle="ButtonStyle.Secondary"
                                  Click="@StartTranslation"
                                  Disabled="@(_isTranslating || _stats.WantedFiles == 0)" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Translation Progress Card -->
    @if (_translationStatus is { IsRunning: true })
    {
        <RadzenRow Gap="1rem" class="rz-mb-4">
            <RadzenColumn Size="12">
                <RadzenCard Style="border-left: 4px solid var(--rz-info);">
                    <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Translation Progress</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-2">@_translationStatus.Progress</RadzenText>
                    <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    }

    <!-- Last Scanned Alert -->
    @if (_stats.LastScanned.HasValue)
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenIcon Icon="info" />
                <RadzenText>Last scan: @_stats.LastScanned.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</RadzenText>
            </RadzenStack>
        </RadzenAlert>
    }
}

@code {
    private LibraryStats? _stats;
    private TranslationStatus? _translationStatus;
    private bool _isLoading = true;
    private bool _isScanning;
    private bool _isTranslating;
    private Timer? _statusTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
        await CheckTranslationStatus();

        // Start polling for translation status
        _statusTimer = new Timer(_ =>
        {
            InvokeAsync(async () => await CheckTranslationStatus()).GetAwaiter().GetResult();
        }, null, TimeSpan.Zero, TimeSpan.FromSeconds(3));
    }

    private async Task LoadStats()
    {
        try
        {
            _isLoading = true;
            _stats = await StatsService.GetLibraryStatsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error loading stats: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ScanLibrary()
    {
        try
        {
            _isScanning = true;
            var result = await LibraryService.ScanLibraryAsync();

            if (result != null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Info,
                    Summary = "Scan Completed",
                    Detail = $"Scan completed: {result.NewFiles} new, {result.UpdatedFiles} updated, {result.RemovedFiles} removed",
                    Duration = 4000
                });
                await LoadStats();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error scanning library: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isScanning = false;
        }
    }

    private async Task StartTranslation()
    {
        try
        {
            _isTranslating = true;
            var success = await TranslationService.StartTranslationAsync(100);

            if (success)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Translation Started",
                    Detail = "Translation started",
                    Duration = 4000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to start translation",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error starting translation: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isTranslating = false;
        }
    }

    private async Task CheckTranslationStatus()
    {
        try
        {
            _translationStatus = await TranslationService.GetTranslationStatusAsync();

            if (_translationStatus is { IsRunning: false, Result: not null })
            {
                // Translation just finished
                await LoadStats();
            }

            StateHasChanged();
        }
        catch
        {
            // Ignore errors during polling
        }
    }

    public void Dispose()
    {
        _statusTimer?.Dispose();
    }
}
