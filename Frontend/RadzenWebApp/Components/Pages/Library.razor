@page "/library"
@inject LibraryApiService LibraryService
@inject NotificationService NotificationService
@inject DialogService DialogService
@implements IDisposable

<PageTitle>Library - Translarr</PageTitle>

<RadzenText TextStyle="TextStyle.H3" class="rz-mb-4">Library</RadzenText>

<!-- Filters Card -->
<RadzenCard class="rz-mb-4">
    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenLabel Text="Search" />
            <RadzenTextBox Placeholder="Search..."
                           @bind-Value="_searchText"
                           @oninput="OnSearchInput"
                           Style="width: 100%;" />
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenLabel Text="Status" />
            <RadzenDropDown TValue="string"
                            Data="@_statusOptions"
                            @bind-Value="_filterProcessed"
                            Change="@ApplyFilters"
                            AllowClear="true"
                            Placeholder="All"
                            Style="width: 100%;" />
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenLabel Text="Wanted" />
            <RadzenDropDown TValue="string"
                            Data="@_wantedOptions"
                            @bind-Value="_filterWanted"
                            Change="@ApplyFilters"
                            AllowClear="true"
                            Placeholder="All"
                            Style="width: 100%;" />
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenLabel Text="Already Has" />
            <RadzenDropDown TValue="string"
                            Data="@_alreadyHasOptions"
                            @bind-Value="_filterAlreadyHas"
                            Change="@ApplyFilters"
                            AllowClear="true"
                            Placeholder="All"
                            Style="width: 100%;" />
        </RadzenColumn>
    </RadzenRow>
</RadzenCard>

<!-- RadzenDataGrid with Card Wrapper -->
<RadzenCard>
    <RadzenDataGrid @ref="_gridRef"
                    TItem="SubtitleEntryDto"
                    Data="@_entries"
                    Count="@_totalCount"
                    LoadData="@LoadData"
                    AllowPaging="true"
                    AllowSorting="true"
                    PageSize="@_pageSize"
                    PagerHorizontalAlign="HorizontalAlign.Center"
                    IsLoading="@_isLoading"
                    EmptyText="No entries found">
        <Columns>
            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Property="Series"
                                  Title="Series"
                                  Sortable="true" />

            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Property="Season"
                                  Title="Season"
                                  Sortable="true" />

            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Property="FileName"
                                  Title="File Name">
                <Template Context="entry">
                    <span title="@entry.FilePath">@entry.FileName</span>
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Title="Status"
                                  Sortable="false"
                                  Width="120px">
                <Template Context="entry">
                    @if (entry.IsProcessed)
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Processed" />
                    }
                    else if (!string.IsNullOrEmpty(entry.ErrorMessage))
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="Error" title="@entry.ErrorMessage" />
                    }
                    else
                    {
                        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Pending" />
                    }
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Title="Wanted"
                                  Sortable="false"
                                  Width="80px">
                <Template Context="entry">
                    <RadzenSwitch @bind-Value="@entry.IsWanted"
                                  Change="@(async (bool value) => await UpdateWantedStatus(entry.Id, value))" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Title="Already Has"
                                  Sortable="false"
                                  Width="120px"
                                  TextAlign="TextAlign.Center">
                <Template Context="entry">
                    @if (entry.AlreadyHad)
                    {
                        <RadzenIcon Icon="check_circle" Style="color: var(--rz-success);" />
                    }
                    else
                    {
                        <RadzenIcon Icon="cancel" Style="color: var(--rz-danger);" />
                    }
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Property="LastScanned"
                                  Title="Last Scanned"
                                  Sortable="true"
                                  Width="180px">
                <Template Context="entry">
                    @entry.LastScanned.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="SubtitleEntryDto"
                                  Title="Actions"
                                  Sortable="false"
                                  Width="80px">
                <Template Context="entry">
                    @if (!string.IsNullOrEmpty(entry.ErrorMessage))
                    {
                        <RadzenButton Icon="info"
                                      ButtonStyle="ButtonStyle.Info"
                                      Size="ButtonSize.Small"
                                      Click="@(() => ShowErrorDetails(entry.ErrorMessage))"
                                      title="View error details" />
                    }
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</RadzenCard>

<!-- Page Size Selector -->
<RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" class="rz-mt-3">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
        <RadzenLabel Text="Items per page:" />
        <RadzenDropDown TValue="int"
                        Data="@_pageSizeOptions"
                        @bind-Value="_pageSize"
                        Change="@OnPageSizeChanged"
                        Style="width: 100px;" />
    </RadzenStack>
</RadzenStack>

@code {
    private RadzenDataGrid<SubtitleEntryDto> _gridRef = null!;
    private IEnumerable<SubtitleEntryDto> _entries = [];
    private int _totalCount;
    private bool _isLoading;
    private int _pageSize = 50;
    private string? _searchText;
    private string? _filterProcessed;
    private string? _filterWanted;
    private string? _filterAlreadyHas;
    private Timer? _debounceTimer;

    private List<int> _pageSizeOptions = [10, 25, 50, 100];
    private Dictionary<string, string> _statusOptions = new()
    {
        { "true", "Processed" },
        { "false", "Not Processed" }
    };
    private Dictionary<string, string> _wantedOptions = new()
    {
        { "true", "Wanted" },
        { "false", "Not Wanted" }
    };
    private Dictionary<string, string> _alreadyHasOptions = new()
    {
        { "true", "Has Subtitles" },
        { "false", "No Subtitles" }
    };

    private async Task LoadData(LoadDataArgs args)
    {
        try
        {
            _isLoading = true;

            // Calculate page from Skip and Top
            var page = args.Skip.HasValue && args.Top.HasValue
                ? (args.Skip.Value / args.Top.Value) + 1
                : 1;
            var pageSize = args.Top ?? _pageSize;

            var result = await LibraryService.GetEntriesAsync(
                page: page,
                pageSize: pageSize,
                isProcessed: ParseBoolFilter(_filterProcessed),
                isWanted: ParseBoolFilter(_filterWanted),
                alreadyHas: ParseBoolFilter(_filterAlreadyHas),
                search: _searchText
            );

            _entries = result?.Items ?? [];
            _totalCount = result?.TotalCount ?? 0;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error loading entries: {ex.Message}",
                Duration = 4000
            });
            _entries = [];
            _totalCount = 0;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private bool? ParseBoolFilter(string? value)
    {
        if (string.IsNullOrEmpty(value)) return null;
        return value == "true";
    }

    private async Task OnPageSizeChanged()
    {
        await _gridRef.Reload();
    }

    private async Task UpdateWantedStatus(int id, bool isWanted)
    {
        try
        {
            await LibraryService.UpdateWantedStatusAsync(id, isWanted);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Updated successfully",
                Duration = 3000
            });
            await _gridRef.Reload();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error updating status: {ex.Message}",
                Duration = 4000
            });
        }
    }

    private void OnSearchInput(ChangeEventArgs args)
    {
        _searchText = args.Value?.ToString();

        // Safely dispose old timer
        var oldTimer = _debounceTimer;
        _debounceTimer = null;
        oldTimer?.Dispose();

        // Create new timer
        _debounceTimer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await _gridRef.Reload();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        await _gridRef.Reload();
    }

    private async Task ShowErrorDetails(string errorMessage)
    {
        await DialogService.Alert(errorMessage, "Error Details");
    }

    public void Dispose()
    {
        var timer = _debounceTimer;
        _debounceTimer = null;
        timer?.Dispose();
    }
}
