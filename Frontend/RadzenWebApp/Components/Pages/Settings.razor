@page "/settings"
@inject SettingsApiService SettingsService
@inject NotificationService NotificationService

<PageTitle>Settings - Translarr</PageTitle>

<RadzenText TextStyle="TextStyle.H3" class="rz-mb-4">Settings</RadzenText>

@if (_isLoading)
{
    <div class="rz-text-align-center rz-my-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
    </div>
}

@if (_settings != null)
{
    <RadzenRow Gap="1rem">
        <!-- Left Column -->
        <RadzenColumn Size="12" SizeMD="6">
            <!-- Gemini API Configuration -->
            <RadzenCard class="rz-mb-4">
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Gemini API Configuration</RadzenText>

                <RadzenStack Gap="1rem">
                    <RadzenStack Gap="0.25rem">
                        <RadzenLabel Text="API Key" />
                        <RadzenPassword @bind-Value="_geminiApiKey" Style="width: 100%;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            @GetSettingDescription("GeminiApiKey")
                        </RadzenText>
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenLabel Text="Model" />
                        <RadzenTextBox @bind-Value="_geminiModel" Style="width: 100%;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            @GetSettingDescription("GeminiModel")
                        </RadzenText>
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenLabel Text="@($"Temperature: {_temperature:F2}")" />
                        <RadzenSlider @bind-Value="_temperature"
                                      Min="0"
                                      Max="1"
                                      Step="0.05"
                                      Style="width: 100%;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            @GetSettingDescription("Temperature")
                        </RadzenText>
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenLabel Text="System Prompt" />
                        <RadzenTextArea @bind-Value="_systemPrompt" Rows="5" Style="width: 100%;" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            @GetSettingDescription("SystemPrompt")
                        </RadzenText>
                    </RadzenStack>

                    <RadzenButton Text="Test API Connection"
                                  ButtonStyle="ButtonStyle.Primary"
                                  Click="@TestApiConnection"
                                  Disabled="@_isTesting" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <!-- Right Column -->
        <RadzenColumn Size="12" SizeMD="6">
            <!-- Translation Settings -->
            <RadzenCard class="rz-mb-4">
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Translation Settings</RadzenText>

                <RadzenStack Gap="0.25rem">
                    <RadzenLabel Text="Preferred Subtitle Language" />
                    <RadzenTextBox @bind-Value="_preferredSubsLang"
                                   Placeholder="e.g., pl, es, fr"
                                   Style="width: 100%;" />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        @GetSettingDescription("PreferredSubsLang")
                    </RadzenText>
                </RadzenStack>
            </RadzenCard>

            <!-- Rate Limiting -->
            <RadzenCard class="rz-mb-4">
                <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Rate Limiting</RadzenText>

                <RadzenStack Gap="1rem">
                    <RadzenStack Gap="0.25rem">
                        <RadzenLabel Text="Requests Per Minute" />
                        <RadzenNumeric @bind-Value="_rateLimitPerMinute"
                                       Min="1"
                                       Style="width: 100%;"
                                       ShowUpDown="true" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            @GetSettingDescription("RateLimitPerMinute")
                        </RadzenText>
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenLabel Text="Requests Per Day" />
                        <RadzenNumeric @bind-Value="_rateLimitPerDay"
                                       Min="1"
                                       Style="width: 100%;"
                                       ShowUpDown="true" />
                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                            @GetSettingDescription("RateLimitPerDay")
                        </RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <!-- Save Button -->
        <RadzenColumn Size="12">
            <RadzenButton Text="@(_isSaving ? "Saving..." : "Save Settings")"
                          Icon="@(_isSaving ? "" : "save")"
                          ButtonStyle="ButtonStyle.Primary"
                          Size="ButtonSize.Large"
                          Click="@SaveAllSettings"
                          Disabled="@_isSaving" />
        </RadzenColumn>
    </RadzenRow>
}

@code {
    private List<AppSettingDto>? _settings;
    private bool _isLoading = true;
    private bool _isTesting;
    private bool _isSaving;

    // Local variables for form fields
    private string _geminiApiKey = "";
    private string _geminiModel = "";
    private string _systemPrompt = "";
    private string _preferredSubsLang = "";
    private double _temperature = 0.55;
    private int _rateLimitPerMinute = 5;
    private int _rateLimitPerDay = 100;

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            _isLoading = true;
            _settings = await SettingsService.GetAllSettingsAsync();

            // Load values into local variables
            _geminiApiKey = GetSettingValue("GeminiApiKey");
            _geminiModel = GetSettingValue("GeminiModel");
            _systemPrompt = GetSettingValue("SystemPrompt");
            _preferredSubsLang = GetSettingValue("PreferredSubsLang");

            // Parse numeric values
            if (double.TryParse(GetSettingValue("Temperature"), out var temp))
                _temperature = temp;

            if (int.TryParse(GetSettingValue("RateLimitPerMinute"), out var rateMin))
                _rateLimitPerMinute = rateMin;

            if (int.TryParse(GetSettingValue("RateLimitPerDay"), out var rateDay))
                _rateLimitPerDay = rateDay;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error loading settings: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string GetSettingValue(string key)
    {
        return _settings?.FirstOrDefault(s => s.Key == key)?.Value ?? "";
    }

    private string GetSettingDescription(string key)
    {
        return _settings?.FirstOrDefault(s => s.Key == key)?.Description ?? "";
    }

    private async Task SaveAllSettings()
    {
        try
        {
            _isSaving = true;
            var errorCount = 0;

            // Save Gemini API settings
            if (!await TrySaveSetting("GeminiApiKey", _geminiApiKey)) errorCount++;
            if (!await TrySaveSetting("GeminiModel", _geminiModel)) errorCount++;
            if (!await TrySaveSetting("Temperature", _temperature.ToString("F2"))) errorCount++;
            if (!await TrySaveSetting("SystemPrompt", _systemPrompt)) errorCount++;

            // Save Translation settings
            if (!await TrySaveSetting("PreferredSubsLang", _preferredSubsLang)) errorCount++;

            // Save Rate Limiting settings
            if (!await TrySaveSetting("RateLimitPerMinute", _rateLimitPerMinute.ToString())) errorCount++;
            if (!await TrySaveSetting("RateLimitPerDay", _rateLimitPerDay.ToString())) errorCount++;

            if (errorCount == 0)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "All settings saved successfully",
                    Duration = 3000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Warning",
                    Detail = $"Settings saved with {errorCount} error(s)",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error saving settings: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task<bool> TrySaveSetting(string key, string value)
    {
        try
        {
            return await SettingsService.UpdateSettingAsync(key, value);
        }
        catch
        {
            return false;
        }
    }

    private async Task TestApiConnection()
    {
        try
        {
            _isTesting = true;

            var result = await SettingsService.TestApiConnectionAsync();

            if (result?.Success == true)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "API connection successful!",
                    Duration = 3000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = $"API connection failed: {result?.Message}",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error testing API: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isTesting = false;
        }
    }
}
