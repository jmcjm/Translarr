@page "/stats"
@inject StatsApiService StatsService
@inject NotificationService NotificationService

<PageTitle>Statistics - Translarr</PageTitle>

<RadzenText TextStyle="TextStyle.H3" class="rz-mb-4">Statistics</RadzenText>

<RadzenRow Gap="1rem">
    <!-- Library Overview -->
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Library Overview</RadzenText>

            @if (_libraryStats != null)
            {
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-2">
                    <RadzenText>Total Files:</RadzenText>
                    <RadzenText TextStyle="TextStyle.Body1"><strong>@_libraryStats.TotalFiles</strong></RadzenText>
                </RadzenStack>
                <hr style="margin: 1rem 0;" />

                <RadzenStack Gap="1rem">
                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText Style="color: var(--rz-success);">Processed:</RadzenText>
                            <RadzenText Style="color: var(--rz-success);"><strong>@_libraryStats.ProcessedFiles</strong></RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@GetPercentage(_libraryStats.ProcessedFiles, _libraryStats.TotalFiles)"
                                           ShowValue="false"
                                           ProgressBarStyle="ProgressBarStyle.Success" />
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText Style="color: var(--rz-warning);">Waiting to Process:</RadzenText>
                            <RadzenText Style="color: var(--rz-warning);"><strong>@_libraryStats.WantedFiles</strong></RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@GetPercentage(_libraryStats.WantedFiles, _libraryStats.TotalFiles)"
                                           ShowValue="false"
                                           ProgressBarStyle="ProgressBarStyle.Warning" />
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText>Unprocessed:</RadzenText>
                            <RadzenText><strong>@_libraryStats.UnprocessedFiles</strong></RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@GetPercentage(_libraryStats.UnprocessedFiles, _libraryStats.TotalFiles)"
                                           ShowValue="false"
                                           ProgressBarStyle="ProgressBarStyle.Secondary" />
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText Style="color: var(--rz-info);">Already Has Subtitles:</RadzenText>
                            <RadzenText Style="color: var(--rz-info);"><strong>@_libraryStats.AlreadyHasFiles</strong></RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@GetPercentage(_libraryStats.AlreadyHasFiles, _libraryStats.TotalFiles)"
                                           ShowValue="false"
                                           ProgressBarStyle="ProgressBarStyle.Info" />
                    </RadzenStack>

                    <RadzenStack Gap="0.25rem">
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                            <RadzenText Style="color: var(--rz-danger);">Errors:</RadzenText>
                            <RadzenText Style="color: var(--rz-danger);"><strong>@_libraryStats.ErrorFiles</strong></RadzenText>
                        </RadzenStack>
                        <RadzenProgressBar Value="@GetPercentage(_libraryStats.ErrorFiles, _libraryStats.TotalFiles)"
                                           ShowValue="false"
                                           ProgressBarStyle="ProgressBarStyle.Danger" />
                    </RadzenStack>
                </RadzenStack>

                @if (_libraryStats.LastScanned.HasValue)
                {
                    <hr style="margin: 1rem 0;" />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        Last scanned: @_libraryStats.LastScanned.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")
                    </RadzenText>
                }
            }
            else if (_isLoading)
            {
                <div class="rz-text-align-center">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                </div>
            }
        </RadzenCard>
    </RadzenColumn>

    <!-- API Usage -->
    <RadzenColumn Size="12" SizeMD="6">
        <RadzenCard>
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" class="rz-mb-3">
                <RadzenText TextStyle="TextStyle.H5">API Usage</RadzenText>
                <RadzenButton Icon="refresh"
                              ButtonStyle="ButtonStyle.Secondary"
                              Variant="Variant.Outlined"
                              Size="ButtonSize.Small"
                              Click="@RefreshApiUsage" />
            </RadzenStack>

            <RadzenStack Gap="1rem" class="rz-mb-3">
                <RadzenStack Gap="0.25rem">
                    <RadzenLabel Text="Time Period" />
                    <RadzenDropDown TValue="string"
                                    Data="@_periodOptions"
                                    @bind-Value="_selectedPeriod"
                                    Change="@LoadApiUsage"
                                    Style="width: 100%;"
                                    TextProperty="Value"
                                    ValueProperty="Key" />
                </RadzenStack>
            </RadzenStack>

            @if (_apiUsage != null && _apiUsage.Any())
            {
                <RadzenText class="rz-mb-3"><strong>Total API Calls:</strong> @_apiUsage.Count</RadzenText>

                <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-2">Recent Activity:</RadzenText>

                <RadzenDataGrid Data="@_apiUsage.OrderByDescending(u => u.Date).Take(10)"
                                TItem="ApiUsageDto"
                                AllowPaging="false"
                                AllowSorting="false"
                                Style="max-height: 300px;">
                    <Columns>
                        <RadzenDataGridColumn TItem="ApiUsageDto" Property="Date" Title="Date" Width="60%">
                            <Template Context="usage">
                                @usage.Date.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="ApiUsageDto" Property="Model" Title="Model" Width="40%" />
                    </Columns>
                </RadzenDataGrid>

                @if (_apiUsage.Count > 10)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mt-2">
                        Showing 10 most recent of @_apiUsage.Count total calls
                    </RadzenText>
                }
            }
            else if (_isLoadingApi)
            {
                <div class="rz-text-align-center">
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Medium" />
                </div>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                    No API usage data available for the selected period.
                </RadzenAlert>
            }
        </RadzenCard>
    </RadzenColumn>

    <!-- Processing Summary -->
    <RadzenColumn Size="12">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H5" class="rz-mb-3">Processing Summary</RadzenText>

            @if (_libraryStats != null)
            {
                <RadzenRow Gap="1rem" class="rz-text-align-center">
                    <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                        <RadzenStack Gap="0.5rem" class="rz-p-3">
                            <RadzenText TextStyle="TextStyle.DisplayH5" Style="color: var(--rz-primary);">@GetProcessingPercentage()%</RadzenText>
                            <RadzenText class="rz-color-secondary">Processing Completion</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                        <RadzenStack Gap="0.5rem" class="rz-p-3">
                            <RadzenText TextStyle="TextStyle.DisplayH5" Style="color: var(--rz-success);">@_libraryStats.ProcessedFiles</RadzenText>
                            <RadzenText class="rz-color-secondary">Successfully Processed</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                        <RadzenStack Gap="0.5rem" class="rz-p-3">
                            <RadzenText TextStyle="TextStyle.DisplayH5" Style="color: var(--rz-warning);">@_libraryStats.WantedFiles</RadzenText>
                            <RadzenText class="rz-color-secondary">In Queue</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeSM="6" SizeMD="3">
                        <RadzenStack Gap="0.5rem" class="rz-p-3">
                            <RadzenText TextStyle="TextStyle.DisplayH5" Style="color: var(--rz-danger);">@_libraryStats.ErrorFiles</RadzenText>
                            <RadzenText class="rz-color-secondary">Failed</RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            }
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private LibraryStats? _libraryStats;
    private List<ApiUsageDto>? _apiUsage;
    private bool _isLoading = true;
    private bool _isLoadingApi = true;
    private string _selectedPeriod = "30days";

    private Dictionary<string, string> _periodOptions = new()
    {
        { "7days", "Last 7 Days" },
        { "30days", "Last 30 Days" },
        { "90days", "Last 90 Days" }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
        await LoadApiUsage();
    }

    private async Task LoadStats()
    {
        try
        {
            _isLoading = true;
            _libraryStats = await StatsService.GetLibraryStatsAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error loading library stats: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadApiUsage()
    {
        try
        {
            _isLoadingApi = true;

            var days = _selectedPeriod switch
            {
                "7days" => 7,
                "90days" => 90,
                _ => 30
            };

            var from = DateTime.UtcNow.AddDays(-days);
            _apiUsage = await StatsService.GetApiUsageStatsAsync(from);
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Error loading API usage: {ex.Message}",
                Duration = 4000
            });
        }
        finally
        {
            _isLoadingApi = false;
        }
    }

    private async Task RefreshApiUsage()
    {
        await LoadApiUsage();
    }

    private double GetPercentage(int value, int total)
    {
        if (total == 0) return 0;
        return (double)value / total * 100;
    }

    private int GetProcessingPercentage()
    {
        if (_libraryStats == null || _libraryStats.TotalFiles == 0) return 0;
        return (int)((double)_libraryStats.ProcessedFiles / _libraryStats.TotalFiles * 100);
    }
}
