@page "/library"
@inject LibraryApiService LibraryService
@inject IHxMessengerService Messenger
@implements IDisposable

<PageTitle>Library - Translarr</PageTitle>

<h1 class="mb-4">Library</h1>

<!-- Filters Card -->
<HxCard CssClass="mb-4">
    <BodyTemplate>
        <div class="row g-3">
            <div class="col-12 col-md-3">
                <label class="form-label">Search</label>
                <div class="input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Search..."
                           @bind="_searchText"
                           @bind:event="oninput"
                           @onkeyup="OnSearchKeyUp" />
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <label class="form-label">Status</label>
                <select class="form-select" @bind="_filterProcessed" @bind:after="ApplyFilters">
                    <option value="">All</option>
                    <option value="true">Processed</option>
                    <option value="false">Not Processed</option>
                </select>
            </div>
            <div class="col-12 col-md-3">
                <label class="form-label">Wanted</label>
                <select class="form-select" @bind="_filterWanted" @bind:after="ApplyFilters">
                    <option value="">All</option>
                    <option value="true">Wanted</option>
                    <option value="false">Not Wanted</option>
                </select>
            </div>
            <div class="col-12 col-md-3">
                <label class="form-label">Already Has</label>
                <select class="form-select" @bind="_filterAlreadyHas" @bind:after="ApplyFilters">
                    <option value="">All</option>
                    <option value="true">Has Subtitles</option>
                    <option value="false">No Subtitles</option>
                </select>
            </div>
        </div>
    </BodyTemplate>
</HxCard>

<!-- HxGrid with Card Wrapper -->
<HxCard CssClass="shadow-sm">
    <BodyTemplate>
        <HxGrid TItem="SubtitleEntryDto"
                DataProvider="GetGridData"
                @ref="_gridRef"
                PageSize="_pageSize"
                Striped="true"
                Hover="true"
                Responsive="true"
                TableCssClass="mb-0">
            <Columns>
                <HxGridColumn HeaderText="Series"
                              ItemTextSelector="@(e => e.Series)"
                              SortString="Series" />

                <HxGridColumn HeaderText="Season"
                              ItemTextSelector="@(e => e.Season)"
                              SortString="Season" />

                <HxGridColumn HeaderText="File Name">
                    <ItemTemplate Context="entry">
                        <span title="@entry.FilePath">@entry.FileName</span>
                    </ItemTemplate>
                </HxGridColumn>

                <HxGridColumn HeaderText="Status">
                    <ItemTemplate Context="entry">
                        @if (entry.IsProcessed)
                        {
                            <HxBadge Color="ThemeColor.Success">Processed</HxBadge>
                        }
                        else if (!string.IsNullOrEmpty(entry.ErrorMessage))
                        {
                            <HxBadge Color="ThemeColor.Danger" title="@entry.ErrorMessage">Error</HxBadge>
                        }
                        else
                        {
                            <HxBadge Color="ThemeColor.Secondary">Pending</HxBadge>
                        }
                    </ItemTemplate>
                </HxGridColumn>

                <HxGridColumn HeaderText="Wanted">
                    <ItemTemplate Context="entry">
                        <div class="form-check form-switch">
                            <input class="form-check-input"
                                   type="checkbox"
                                   role="switch"
                                   checked="@entry.IsWanted"
                                   @onchange="@(async (e) => await UpdateWantedStatus(entry.Id, (bool)e.Value!))" />
                        </div>
                    </ItemTemplate>
                </HxGridColumn>

                <HxGridColumn HeaderText="Already Has">
                    <ItemTemplate Context="entry">
                        @if (entry.AlreadyHad)
                        {
                            <HxIcon Icon="BootstrapIcon.CheckCircleFill" CssClass="text-success" />
                        }
                        else
                        {
                            <HxIcon Icon="BootstrapIcon.XCircleFill" CssClass="text-danger" />
                        }
                    </ItemTemplate>
                </HxGridColumn>

                <HxGridColumn HeaderText="Last Scanned"
                              ItemTextSelector="@(e => e.LastScanned.ToLocalTime().ToString("yyyy-MM-dd HH:mm"))"
                              SortString="LastScanned" />

                <HxGridColumn HeaderText="Actions">
                    <ItemTemplate Context="entry">
                        @if (!string.IsNullOrEmpty(entry.ErrorMessage))
                        {
                            <HxButton Color="ThemeColor.Info"
                                      Size="ButtonSize.Small"
                                      OnClick="@(() => ShowErrorDetails(entry.ErrorMessage))"
                                      title="View error details">
                                <HxIcon Icon="BootstrapIcon.InfoCircle" />
                            </HxButton>
                        }
                    </ItemTemplate>
                </HxGridColumn>
            </Columns>

            <EmptyDataTemplate>
                <div class="text-center text-muted p-4">No entries found</div>
            </EmptyDataTemplate>

            <LoadingDataTemplate>
                <div class="d-flex justify-content-center p-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </LoadingDataTemplate>
        </HxGrid>
    </BodyTemplate>
</HxCard>

<!-- Page Size Selector -->
<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        <label class="form-label me-2">Items per page:</label>
        <select class="form-select d-inline-block w-auto" @bind="_pageSize" @bind:after="OnPageSizeChanged">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>
</div>

@code {
    private HxGrid<SubtitleEntryDto> _gridRef = null!;
    private int _pageSize = 50;
    private string? _searchText;
    private string? _filterProcessed;
    private string? _filterWanted;
    private string? _filterAlreadyHas;
    private Timer? _debounceTimer;

    private async Task<GridDataProviderResult<SubtitleEntryDto>> GetGridData(
        GridDataProviderRequest<SubtitleEntryDto> request)
    {
        try
        {
            // Calculate page from StartIndex and Count (as per Havit docs examples)
            var page = request.StartIndex / request.Count + 1;

            var result = await LibraryService.GetEntriesAsync(
                page: page!.Value,
                pageSize: request.Count!.Value,
                isProcessed: ParseBoolFilter(_filterProcessed),
                isWanted: ParseBoolFilter(_filterWanted),
                alreadyHas: ParseBoolFilter(_filterAlreadyHas),
                search: _searchText
            );

            return new GridDataProviderResult<SubtitleEntryDto>
            {
                Data = result?.Items ?? [],
                TotalCount = result?.TotalCount ?? 0
            };
        }
        catch (Exception ex)
        {
            Messenger.AddError($"Error loading entries: {ex.Message}");
            return new GridDataProviderResult<SubtitleEntryDto>
            {
                Data = [],
                TotalCount = 0
            };
        }
    }

    private bool? ParseBoolFilter(string? value)
    {
        if (string.IsNullOrEmpty(value)) return null;
        return value == "true";
    }

    private async Task OnPageSizeChanged()
    {
        await _gridRef.RefreshDataAsync();
    }

    private async Task UpdateWantedStatus(int id, bool isWanted)
    {
        try
        {
            await LibraryService.UpdateWantedStatusAsync(id, isWanted);
            Messenger.AddInformation("Updated successfully");
            await _gridRef.RefreshDataAsync();
        }
        catch (Exception ex)
        {
            Messenger.AddError($"Error updating status: {ex.Message}");
        }
    }

    private void OnSearchKeyUp(KeyboardEventArgs args)
    {
        // Safely dispose old timer
        var oldTimer = _debounceTimer;
        _debounceTimer = null;
        oldTimer?.Dispose();

        // Create new timer
        _debounceTimer = new Timer(_ =>
        {
            InvokeAsync(async () =>
            {
                await _gridRef.RefreshDataAsync();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        await _gridRef.RefreshDataAsync();
    }

    private void ShowErrorDetails(string errorMessage)
    {
        Messenger.AddError(errorMessage);
    }

    public void Dispose()
    {
        var timer = _debounceTimer;
        _debounceTimer = null;
        timer?.Dispose();
    }
}
