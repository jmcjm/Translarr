@page "/series"
@inject SeriesWatchApiService SeriesWatchService
@inject ISnackbar Snackbar

<PageTitle>Series Management - Translarr</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Series Management</MudText>

<MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
    Manage auto-watch settings and bulk operations for your series and seasons.
</MudText>

@if (_isLoading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
}

@if (_seriesGroups != null && _seriesGroups.Any())
{
    <MudCard Elevation="2" Class="mb-4">
        <MudCardContent>
            <MudTextField @bind-Value="_searchText"
                          Label="Search Series"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          OnKeyUp="OnSearchKeyUp"
                          Immediate="true" />
        </MudCardContent>
    </MudCard>

    <MudGrid>
        @foreach (var series in _filteredSeriesGroups)
        {
            <MudItem xs="12">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Tv" Size="Size.Medium" />
                                <MudText Typo="Typo.h6">@series.SeriesName</MudText>
                                @if (series.IsWatched)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Visibility">Watched</MudChip>
                                }
                            </MudStack>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@(_expandedSeries.Contains(series.SeriesName) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                           Color="Color.Default"
                                           OnClick="@(() => ToggleSeriesExpanded(series.SeriesName))" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Row="true" Spacing="4" Class="mb-3">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                <strong>Total:</strong> @series.TotalFiles files
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Warning">
                                <strong>Wanted:</strong> @series.WantedFiles
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Success">
                                <strong>Processed:</strong> @series.ProcessedFiles
                            </MudText>
                        </MudStack>

                        <MudStack Row="true" Spacing="2">
                            <MudSwitch T="bool"
                                       Value="@series.IsWatched"
                                       Color="Color.Info"
                                       Label="Auto-watch entire series"
                                       ThumbIcon="@(series.IsWatched ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                       ValueChanged="@(async (bool val) => await ToggleSeriesWatch(series.SeriesName, val))" />

                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                       Size="Size.Small"
                                       OnClick="@(() => BulkMarkWanted(series.SeriesName, null, true))">
                                Mark All Wanted
                            </MudButton>

                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Secondary"
                                       StartIcon="@Icons.Material.Filled.Cancel"
                                       Size="Size.Small"
                                       OnClick="@(() => BulkMarkWanted(series.SeriesName, null, false))">
                                Mark All Unwanted
                            </MudButton>
                        </MudStack>

                        @if (_expandedSeries.Contains(series.SeriesName))
                        {
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.subtitle1" Class="mb-3">Seasons</MudText>

                            <MudGrid>
                                @foreach (var season in series.Seasons)
                                {
                                    <MudItem xs="12" md="6">
                                        <MudPaper Elevation="1" Class="pa-4">
                                            <MudStack Spacing="2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudText Typo="Typo.subtitle2">@season.SeasonName</MudText>
                                                    @if (season.IsWatched)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Visibility">Watched</MudChip>
                                                    }
                                                </MudStack>

                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                    @season.TotalFiles files | @season.WantedFiles wanted | @season.ProcessedFiles processed
                                                </MudText>

                                                @if (!series.IsWatched)
                                                {
                                                    <MudSwitch T="bool"
                                                               Value="@season.IsWatched"
                                                               Color="Color.Info"
                                                               Label="Auto-watch season"
                                                               Size="Size.Small"
                                                               ThumbIcon="@(season.IsWatched ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                                               ValueChanged="@(async (bool val) => await ToggleSeasonWatch(series.SeriesName, season.SeasonName, val))" />
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                                        Auto-watch inherited from series
                                                    </MudText>
                                                }

                                                <MudStack Row="true" Spacing="1">
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.CheckCircle"
                                                               OnClick="@(() => BulkMarkWanted(series.SeriesName, season.SeasonName, true))">
                                                        Mark Wanted
                                                    </MudButton>

                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Secondary"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.Cancel"
                                                               OnClick="@(() => BulkMarkWanted(series.SeriesName, season.SeasonName, false))">
                                                        Mark Unwanted
                                                    </MudButton>
                                                </MudStack>
                                            </MudStack>
                                        </MudPaper>
                                    </MudItem>
                                }
                            </MudGrid>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
}
else if (!_isLoading)
{
    <MudAlert Severity="Severity.Info">
        No series found. Run a library scan to populate your media library.
    </MudAlert>
}

@code {
    private List<SeriesGroupDto>? _seriesGroups;
    private List<SeriesGroupDto> _filteredSeriesGroups = [];
    private HashSet<string> _expandedSeries = [];
    private bool _isLoading = true;
    private string _searchText = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadSeriesGroups();
    }

    private async Task LoadSeriesGroups()
    {
        try
        {
            _isLoading = true;
            _seriesGroups = await SeriesWatchService.GetSeriesGroupsAsync() ?? [];
            FilterSeriesGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading series: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterSeriesGroups()
    {
        if (_seriesGroups == null)
        {
            _filteredSeriesGroups = [];
            return;
        }

        if (string.IsNullOrWhiteSpace(_searchText))
        {
            _filteredSeriesGroups = _seriesGroups;
        }
        else
        {
            var search = _searchText.ToLowerInvariant();
            _filteredSeriesGroups = _seriesGroups
                .Where(s => s.SeriesName.ToLowerInvariant().Contains(search))
                .ToList();
        }
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        FilterSeriesGroups();
    }

    private void ToggleSeriesExpanded(string seriesName)
    {
        if (_expandedSeries.Contains(seriesName))
            _expandedSeries.Remove(seriesName);
        else
            _expandedSeries.Add(seriesName);
    }

    private async Task ToggleSeriesWatch(string seriesName, bool watched)
    {
        try
        {
            var result = await SeriesWatchService.SetAutoWatchAsync(seriesName, null, watched);
            if (result != null && watched)
            {
                Snackbar.Add($"Auto-watch enabled for '{seriesName}'. {result.FilesMarkedWanted} files marked as wanted.", Severity.Success);
            }
            else if (!watched)
            {
                Snackbar.Add($"Auto-watch disabled for '{seriesName}'.", Severity.Info);
            }

            await LoadSeriesGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error toggling watch: {ex.Message}", Severity.Error);
        }
    }

    private async Task ToggleSeasonWatch(string seriesName, string seasonName, bool watched)
    {
        try
        {
            var result = await SeriesWatchService.SetAutoWatchAsync(seriesName, seasonName, watched);
            if (result != null && watched)
            {
                Snackbar.Add($"Auto-watch enabled for '{seriesName} - {seasonName}'. {result.FilesMarkedWanted} files marked as wanted.", Severity.Success);
            }
            else if (!watched)
            {
                Snackbar.Add($"Auto-watch disabled for '{seriesName} - {seasonName}'.", Severity.Info);
            }

            await LoadSeriesGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error toggling watch: {ex.Message}", Severity.Error);
        }
    }

    private async Task BulkMarkWanted(string seriesName, string? seasonName, bool wanted)
    {
        try
        {
            var count = await SeriesWatchService.BulkSetWantedAsync(seriesName, seasonName, wanted);
            var scope = seasonName != null ? $"{seriesName} - {seasonName}" : seriesName;
            Snackbar.Add($"{count} files in '{scope}' marked as {(wanted ? "wanted" : "unwanted")}.", Severity.Success);

            await LoadSeriesGroups();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error bulk updating: {ex.Message}", Severity.Error);
        }
    }
}
